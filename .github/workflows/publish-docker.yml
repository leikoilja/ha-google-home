name: CD-docker

on:
  push:
    branches:
      - main
      - feature/docker-with-prerequisites

jobs:
  build:
    name: 🔨 Build the Docker image
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ⬇️ Setup buildx
        id: buildx
        uses: docker/setup-buildx-action@v2
        with:
          buildkitd-flags: --debug

      - name: 🔨 Build the docker image
        uses: docker/build-push-action@v3
        with:
          context: .
          platforms: linux/amd64,
          file: ./image-with-prerequisites.dockerfile
          load: true
          tags: >-
            ghcr.io/luttik/home-assistant:test-latest
#      - name: 🧪 Test the docker image
#        run: |
#          docker run \
#            --rm \
#            ghcr.io/luttik/home-assistant:test-latest \
#            # A command
#      - name: 🏷️ Calculate tag
#        id: date_tag
#        run: |
#          echo "::set-output name=date_tag::$(date "+%Y-%m-%d.%H-%M-%S")"
      - name: 🚀 Deploy the docker image
        uses: docker/build-push-action@v3
        with:
          context: .
          platforms: linux/amd64,
          file: ./image-with-prerequisites.dockerfile
          push: true
          tags: >-
            ghcr.io/luttik/home-assistant:latest,
#            ghcr.io/luttik/home-assistant:${{ steps.date_tag.outputs.date_tag }}
